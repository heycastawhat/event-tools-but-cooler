<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="theme.js"></script>
    <script src="sync.js"></script>
    <title>Admin Panel - Event Tools</title>
    <style>
        .mobile-home { display: none; }
        .tile-dashboard { display: none; }

        @media (max-width: 768px) {
            .mobile-home { display: flex; }
        }
        @media (min-width: 769px) {
            .tile-dashboard { display: grid; }
        }

        .tile-dashboard {
            width: 100%;
            max-width: 750px;
            margin: 0 auto;
            padding: 2rem;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 140px;
            gap: 1rem;
            align-content: center;
            min-height: 100vh;
        }

        .tile {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
            position: relative;
        }

        .tile:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
            transform: translateY(-2px);
        }

        .tile-wide { grid-column: span 2; }
        .tile-tall { grid-row: span 2; }

        .tile-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .tile-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .tile-sub {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .tile-accent {
            background: var(--accent);
            border-color: var(--accent);
        }

        .tile-accent .tile-title,
        .tile-accent .tile-value,
        .tile-accent .tile-sub {
            color: #fff;
        }

        .tile-accent:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .tile-scores-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
        }

        .tile-score-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .tile-score-rank {
            color: var(--text-muted);
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .tile-score-name {
            color: var(--text-primary);
            flex: 1;
        }

        .tile-score-pts {
            color: var(--accent);
            font-weight: 700;
        }

        .admin-layout {
            max-width: 1000px;
            padding: 1.5rem;
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 769px) {
            .admin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .admin-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .admin-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
        }

        .admin-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .admin-stat-row {
            display: flex;
            gap: 1.5rem;
        }

        .admin-stat {
            text-align: center;
            flex: 1;
        }

        .admin-stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .admin-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        .admin-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .admin-stat-item {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .admin-stat-item .admin-stat-value {
            font-size: 1.5rem;
            display: block;
        }

        .admin-stat-item .admin-stat-label {
            display: block;
            margin-top: 0.25rem;
        }

        .feature-toggles {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .feature-toggle input[type="checkbox"] {
            width: auto;
            padding: 0;
            margin: 0;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="hamburger-menu left">
        <button class="hamburger-btn" onclick="toggleMenu()">&#9776;</button>
        <div id="menuDropdown" class="sidebar-menu">
            <button onclick="showNewEventModal()" class="sidebar-item">New Event</button>
            <button onclick="showCustomizeModal()" class="sidebar-item">Customise</button>
            <button onclick="showSettingsModal()" class="sidebar-item">Settings</button>
            <button onclick="showSearch()" class="sidebar-item">Search</button>
        </div>
    </div>

    <div id="newEventModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">Start New Event?</div>
            <div class="modal-text">This will clear all teams, scores, and schedule data.</div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="confirmNewEvent()">Yes, Start Fresh</button>
                <button class="btn btn-secondary" onclick="closeNewEventModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="customizeModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-title">Customise</div>
            <div class="customize-options">
                <div class="customize-group">
                    <label>Accent Colour</label>
                    <div class="color-options">
                        <button class="color-swatch" style="background: #58a6ff;" onclick="setAccentColor('#58a6ff')" data-color="#58a6ff"></button>
                        <button class="color-swatch" style="background: #f78166;" onclick="setAccentColor('#f78166')" data-color="#f78166"></button>
                        <button class="color-swatch" style="background: #a371f7;" onclick="setAccentColor('#a371f7')" data-color="#a371f7"></button>
                        <button class="color-swatch" style="background: #3fb950;" onclick="setAccentColor('#3fb950')" data-color="#3fb950"></button>
                        <button class="color-swatch" style="background: #f0883e;" onclick="setAccentColor('#f0883e')" data-color="#f0883e"></button>
                        <button class="color-swatch" style="background: #db61a2;" onclick="setAccentColor('#db61a2')" data-color="#db61a2"></button>
                    </div>
                </div>
                <div class="customize-group">
                    <label>Font Size</label>
                    <div class="font-size-options">
                        <button class="btn btn-secondary font-size-btn" onclick="setFontSize('small')" data-size="small">Small</button>
                        <button class="btn btn-secondary font-size-btn" onclick="setFontSize('medium')" data-size="medium">Medium</button>
                        <button class="btn btn-secondary font-size-btn" onclick="setFontSize('large')" data-size="large">Large</button>
                    </div>
                </div>
                <div class="customize-group">
                    <label>Theme</label>
                    <div class="theme-options">
                        <button class="btn btn-secondary theme-btn" onclick="setTheme('dark')" data-theme="dark">Dark</button>
                        <button class="btn btn-secondary theme-btn" onclick="setTheme('light')" data-theme="light">Light</button>
                    </div>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeCustomizeModal()">Done</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-title">Settings</div>
            <div class="customize-options">
                <div class="customize-group">
                    <div class="setting-row">
                        <label>Sound Effects</label>
                        <button class="toggle-btn" id="soundToggle" onclick="toggleSetting('sound')">
                            <span class="toggle-slider"></span>
                        </button>
                    </div>
                </div>
                <div class="customize-group">
                    <div class="setting-row">
                        <label>Vibration</label>
                        <button class="toggle-btn" id="vibrationToggle" onclick="toggleSetting('vibration')">
                            <span class="toggle-slider"></span>
                        </button>
                    </div>
                </div>
                <div class="customize-group">
                    <div class="setting-row">
                        <label>Confirm before clearing</label>
                        <button class="toggle-btn" id="confirmToggle" onclick="toggleSetting('confirm')">
                            <span class="toggle-slider"></span>
                        </button>
                    </div>
                </div>
                <div class="customize-group" style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 0.5rem;">
                    <label>Data</label>
                    <div class="flex gap-2 mt-2">
                        <button class="btn btn-secondary" onclick="exportData()" style="flex: 1;">Export</button>
                        <button class="btn btn-secondary" onclick="importData()" style="flex: 1;">Import</button>
                    </div>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeSettingsModal()">Done</button>
            </div>
        </div>
    </div>

    <div id="searchModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <input type="text" id="searchInput" placeholder="Search tools and features..." oninput="filterSearch()" autofocus style="width: 100%; margin-bottom: 1rem;">
            <div id="searchResults" class="search-results"></div>
        </div>
    </div>

    <div id="onboarding" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="onboard-progress">
                <div class="onboard-dots">
                    <span class="onboard-dot active" data-step="0"></span>
                    <span class="onboard-dot" data-step="1"></span>
                    <span class="onboard-dot" data-step="2"></span>
                    <span class="onboard-dot" data-step="3"></span>
                </div>
            </div>

            <!-- Step 0: Welcome -->
            <div class="onboard-step" data-step="0">
                <div class="modal-title">Welcome to Event Tools</div>
                <div class="modal-text">Let's get your event set up in just a few steps.</div>
            </div>

            <!-- Step 1: Teams -->
            <div class="onboard-step" data-step="1" style="display: none;">
                <div class="modal-title">Add Participants</div>
                <div class="modal-text">Enter the names of everyone at your event, one per line.</div>
                <textarea id="onboardPeople" placeholder="Alice&#10;Bob&#10;Charlie&#10;..." rows="6" style="width: 100%; resize: vertical;"></textarea>
            </div>

            <!-- Step 2: Appearance -->
            <div class="onboard-step" data-step="2" style="display: none;">
                <div class="modal-title">Appearance</div>
                <div class="modal-text">Customise the look and feel.</div>
                <div class="customize-options">
                <div class="customize-group">
                    <label>Accent Colour</label>
                        <div class="color-options">
                            <button class="color-swatch" style="background: #58a6ff;" onclick="setAccentColor('#58a6ff')" data-color="#58a6ff"></button>
                            <button class="color-swatch" style="background: #f78166;" onclick="setAccentColor('#f78166')" data-color="#f78166"></button>
                            <button class="color-swatch" style="background: #a371f7;" onclick="setAccentColor('#a371f7')" data-color="#a371f7"></button>
                            <button class="color-swatch" style="background: #3fb950;" onclick="setAccentColor('#3fb950')" data-color="#3fb950"></button>
                            <button class="color-swatch" style="background: #f0883e;" onclick="setAccentColor('#f0883e')" data-color="#f0883e"></button>
                            <button class="color-swatch" style="background: #db61a2;" onclick="setAccentColor('#db61a2')" data-color="#db61a2"></button>
                        </div>
                    </div>
                    <div class="customize-group">
                        <label>Theme</label>
                        <div class="theme-options">
                            <button class="btn btn-secondary theme-btn" onclick="setTheme('dark')" data-theme="dark">Dark</button>
                            <button class="btn btn-secondary theme-btn" onclick="setTheme('light')" data-theme="light">Light</button>
                        </div>
                    </div>
                    <div class="customize-group">
                        <label>Font Size</label>
                        <div class="font-size-options">
                            <button class="btn btn-secondary font-size-btn" onclick="setFontSize('small')" data-size="small">Small</button>
                            <button class="btn btn-secondary font-size-btn" onclick="setFontSize('medium')" data-size="medium">Medium</button>
                            <button class="btn btn-secondary font-size-btn" onclick="setFontSize('large')" data-size="large">Large</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- schedule onboarding removed -->

            <div class="onboard-nav">
                <div></div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" id="onboardBack" onclick="onboardPrev()" style="display: none;">Back</button>
                    <button class="btn btn-primary" id="onboardNext" onclick="onboardNext()">Get Started</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importInput" accept=".json" style="display: none;" onchange="handleImport(event)">

    <!-- Admin Panel Layout -->
    <div class="container admin-layout">
        <div class="admin-header">
            <h1 style="font-size:1.75rem;margin:0;">Admin Panel</h1>
            <div class="flex gap-2">
                <button class="btn btn-primary" onclick="window.location.href='controller.html'">Controller</button>
                <button class="btn btn-secondary" onclick="window.open('display.html', '_blank')">Open Display</button>
            </div>
        </div>

        <div class="admin-grid">
            <!-- Connections -->
            <div class="admin-card">
                <div class="admin-card-title">Connections</div>
                <div class="admin-stat-row">
                    <div class="admin-stat">
                        <div class="admin-stat-value" id="adminClientCount">â€”</div>
                        <div class="admin-stat-label">Total Connected</div>
                    </div>
                </div>
                <div id="adminNetworkURL" style="display:none;" class="mt-2">
                    <div class="text-muted text-sm mb-1">Controller URL:</div>
                    <div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-sm);padding:0.5rem;font-family:monospace;font-size:0.8rem;color:var(--accent);user-select:all;cursor:pointer;word-break:break-all;" onclick="navigator.clipboard.writeText(this.textContent.trim())" title="Click to copy" id="adminNetworkURLText"></div>
                </div>
            </div>

            <!-- Event Setup -->
            <div class="admin-card">
                <div class="admin-card-title">Event Setup</div>
                <div class="mb-2">
                    <label style="font-size:0.8rem;">Event Name</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="adminEventName" placeholder="My Event" style="flex:1;">
                        <button class="btn btn-primary" onclick="broadcastEventName()">Set</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="showNewEventModal()" style="width:100%;margin-top:0.5rem;">New Event (Reset All)</button>
            </div>

            <!-- Theme Broadcast -->
            <div class="admin-card">
                <div class="admin-card-title">Theme (All Devices)</div>
                <div class="mb-2">
                    <label style="font-size:0.8rem;">Theme</label>
                    <div class="flex gap-2 mt-1">
                        <button class="btn btn-secondary" onclick="broadcastTheme('dark')" style="flex:1;">Dark</button>
                        <button class="btn btn-secondary" onclick="broadcastTheme('light')" style="flex:1;">Light</button>
                        <button class="btn btn-secondary" onclick="broadcastTheme('mocha')" style="flex:1;">Mocha</button>
                    </div>
                </div>
                <div>
                    <label style="font-size:0.8rem;">Accent Colour</label>
                    <div class="color-options mt-1">
                        <button class="color-swatch" style="background:#58a6ff;" onclick="broadcastAccent('#58a6ff')"></button>
                        <button class="color-swatch" style="background:#f78166;" onclick="broadcastAccent('#f78166')"></button>
                        <button class="color-swatch" style="background:#a371f7;" onclick="broadcastAccent('#a371f7')"></button>
                        <button class="color-swatch" style="background:#3fb950;" onclick="broadcastAccent('#3fb950')"></button>
                        <button class="color-swatch" style="background:#f0883e;" onclick="broadcastAccent('#f0883e')"></button>
                        <button class="color-swatch" style="background:#db61a2;" onclick="broadcastAccent('#db61a2')"></button>
                    </div>
                </div>
            </div>

            <!-- Controller Features -->
            <div class="admin-card">
                <div class="admin-card-title">Controller Features</div>
                <p class="text-muted text-sm mb-2">Toggle which scenes are available on the controller.</p>
                <div class="feature-toggles" id="featureToggles">
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="welcome" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Welcome</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="teams" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Teams</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="scoreboard" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Scoreboard</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="timer" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Timer</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="picker" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Picker</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="message" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Message</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="slides" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Slides</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="camera" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Camera</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="waiting" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Waiting</span></div>
                    <div class="feature-toggle" onclick="this.querySelector('input').click()"><input type="checkbox" data-feature="blank" checked onchange="saveFeatures()" onclick="event.stopPropagation()"><span>Blank</span></div>
                </div>
            </div>

            <!-- Stats -->
            <div class="admin-card">
                <div class="admin-card-title">Stats</div>
                <div class="admin-stats-grid" id="adminStats">
                    <div class="admin-stat-item"><span class="admin-stat-value" id="statParticipants">0</span><span class="admin-stat-label">Participants</span></div>
                    <div class="admin-stat-item"><span class="admin-stat-value" id="statTeams">0</span><span class="admin-stat-label">Teams</span></div>
                    <div class="admin-stat-item"><span class="admin-stat-value" id="statRounds">0</span><span class="admin-stat-label">Rounds</span></div>
                    <div class="admin-stat-item"><span class="admin-stat-value" id="statTopScore">0</span><span class="admin-stat-label">Top Score</span></div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="admin-card">
                <div class="admin-card-title">Quick Actions</div>
                <div class="flex gap-2 mb-2" style="flex-wrap:wrap;">
                    <button class="btn btn-secondary" onclick="window.location.href='teamgen.html'" style="flex:1;">Team Generator</button>
                    <button class="btn btn-secondary" onclick="window.location.href='scoring.html'" style="flex:1;">Scoring</button>
                </div>
                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <button class="btn btn-secondary" onclick="playAttention()" style="flex:1;">Attention</button>
                    <button class="btn btn-secondary" onclick="exportData()" style="flex:1;">Export Data</button>
                    <button class="btn btn-secondary" onclick="importData()" style="flex:1;">Import Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const host = location.hostname;
            if (host !== 'localhost' && host !== '127.0.0.1') {
                const url = location.origin + '/controller.html';
                var el = document.getElementById('adminNetworkURLText');
                var container = document.getElementById('adminNetworkURL');
                if (el) el.textContent = url;
                if (container) container.style.display = '';
            }
        })();

        // Admin: broadcast event name to display
        function broadcastEventName() {
            var name = document.getElementById('adminEventName').value.trim();
            if (!name) return;
            localStorage.setItem('eventToolsEventName', name);
            sendCommand('set-event-name', { name: name });
        }

        // Admin: broadcast theme to all devices
        function broadcastTheme(theme) {
            localStorage.setItem('eventToolsTheme', theme);
            sendCommand('set-theme', { theme: theme });
        }

        // Admin: broadcast accent colour to all devices
        function broadcastAccent(color) {
            localStorage.setItem('eventToolsAccent', color);
            sendCommand('set-accent', { color: color });
        }

        // Admin: controller feature toggles
        function saveFeatures() {
            var toggles = document.querySelectorAll('#featureToggles input[data-feature]');
            var features = {};
            toggles.forEach(function(t) { features[t.dataset.feature] = t.checked; });
            localStorage.setItem('eventToolsFeatures', JSON.stringify(features));
            sendCommand('ctrl-features', { features: features });
        }

        function loadFeatures() {
            try {
                var raw = localStorage.getItem('eventToolsFeatures');
                if (raw) {
                    var features = JSON.parse(raw);
                    Object.keys(features).forEach(function(key) {
                        var cb = document.querySelector('#featureToggles input[data-feature="' + key + '"]');
                        if (cb) cb.checked = features[key];
                    });
                }
            } catch(e) {}
        }

        // Admin: refresh stats from localStorage
        function refreshStats() {
            try {
                var praw = localStorage.getItem('eventToolsParticipants');
                var participants = praw ? JSON.parse(praw) : [];
                document.getElementById('statParticipants').textContent = participants.length;
            } catch(e) {}

            try {
                var traw = localStorage.getItem('eventToolsTeams');
                var teams = traw ? JSON.parse(traw) : [];
                document.getElementById('statTeams').textContent = teams.length;
            } catch(e) {}

            try {
                var sraw = localStorage.getItem('eventToolsScoring');
                if (sraw) {
                    var sdata = JSON.parse(sraw);
                    var steams = sdata.teams || [];
                    var rounds = steams.length > 0 ? steams[0].scores.length : 0;
                    var topScore = 0;
                    steams.forEach(function(t) {
                        var s = t.scores.reduce(function(a,b){return a+b;}, 0);
                        if (s > topScore) topScore = s;
                    });
                    document.getElementById('statRounds').textContent = rounds;
                    document.getElementById('statTopScore').textContent = topScore;
                }
            } catch(e) {}
        }

        refreshStats();
        loadFeatures();

        // Load saved event name
        (function() {
            var saved = localStorage.getItem('eventToolsEventName');
            if (saved) document.getElementById('adminEventName').value = saved;
        })();

        function pollClients() {
            fetch('/api/clients').then(function(r) { return r.json(); }).then(function(data) {
                var count = data.count || 0;
                document.getElementById('adminClientCount').textContent = count;
            }).catch(function() {});
        }
        pollClients();
        setInterval(pollClients, 3000);

        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                document.body.style.overflow = '';
            } else {
                menu.classList.add('open');
                document.body.style.overflow = 'hidden';
            }
        }

        // Close sidebar when clicking outside or on menu item
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('menuDropdown');
            const hamburger = e.target.closest('.hamburger-menu');
            if (!hamburger && menu.classList.contains('open')) {
                menu.classList.remove('open');
                document.body.style.overflow = '';
            }
        });
        // Also close sidebar when clicking a menu item
        document.querySelectorAll('.sidebar-item').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('menuDropdown').classList.remove('open');
                document.body.style.overflow = '';
            });
        });

        function showNewEventModal() {
            document.getElementById('newEventModal').style.display = 'flex';
        }

        function closeNewEventModal() {
            document.getElementById('newEventModal').style.display = 'none';
        }

        function confirmNewEvent() {
            localStorage.removeItem('eventToolsTeams');
            localStorage.removeItem('eventToolsScoring');
            // schedule removed
            localStorage.removeItem('eventToolsPicker');
            localStorage.removeItem('eventToolsParticipants');
            localStorage.removeItem('eventTools_onboarded');
            closeNewEventModal();
            startOnboarding();
        }

        function showCustomizeModal() {
            document.getElementById('customizeModal').style.display = 'flex';
            updateCustomizeSelection();
        }

        function closeCustomizeModal() {
            document.getElementById('customizeModal').style.display = 'none';
        }

        function setAccentColor(color) {
            document.documentElement.style.setProperty('--accent', color);
            localStorage.setItem('eventToolsAccent', color);
            updateCustomizeSelection();
        }

        function setFontSize(size) {
            const sizes = { small: '14px', medium: '16px', large: '18px' };
            document.documentElement.style.setProperty('--base-font-size', sizes[size]);
            localStorage.setItem('eventToolsFontSize', size);
            updateCustomizeSelection();
        }

        function setTheme(theme) {
            if (theme === 'light') {
                document.documentElement.style.setProperty('--bg-primary', '#ffffff');
                document.documentElement.style.setProperty('--bg-secondary', '#f6f8fa');
                document.documentElement.style.setProperty('--bg-tertiary', '#eaeef2');
                document.documentElement.style.setProperty('--text-primary', '#1f2328');
                document.documentElement.style.setProperty('--text-secondary', '#656d76');
                document.documentElement.style.setProperty('--text-muted', '#8b949e');
                document.documentElement.style.setProperty('--border', '#d0d7de');
            } else {
                document.documentElement.style.setProperty('--bg-primary', '#0d1117');
                document.documentElement.style.setProperty('--bg-secondary', '#161b22');
                document.documentElement.style.setProperty('--bg-tertiary', '#21262d');
                document.documentElement.style.setProperty('--text-primary', '#e6edf3');
                document.documentElement.style.setProperty('--text-secondary', '#8b949e');
                document.documentElement.style.setProperty('--text-muted', '#6e7681');
                document.documentElement.style.setProperty('--border', '#30363d');
            }
            localStorage.setItem('eventToolsTheme', theme);
            updateCustomizeSelection();
        }

        function updateCustomizeSelection() {
            const accent = localStorage.getItem('eventToolsAccent') || '#58a6ff';
            const fontSize = localStorage.getItem('eventToolsFontSize') || 'medium';
            const theme = localStorage.getItem('eventToolsTheme') || 'dark';

            document.querySelectorAll('.color-swatch').forEach(el => {
                el.classList.toggle('active', el.dataset.color === accent);
            });
            document.querySelectorAll('.font-size-btn').forEach(el => {
                el.classList.toggle('active', el.dataset.size === fontSize);
            });
            document.querySelectorAll('.theme-btn').forEach(el => {
                el.classList.toggle('active', el.dataset.theme === theme);
            });
        }

        function loadCustomization() {
            const accent = localStorage.getItem('eventToolsAccent');
            const fontSize = localStorage.getItem('eventToolsFontSize');
            const theme = localStorage.getItem('eventToolsTheme');
            if (accent) setAccentColor(accent);
            if (fontSize) setFontSize(fontSize);
            if (theme) setTheme(theme);
        }

        loadCustomization();

        function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
            updateSettingsToggles();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function toggleSetting(setting) {
            const key = `eventTools_${setting}`;
            const defaultOn = ['sound', 'vibration', 'confirm'];
            const current = defaultOn.includes(setting)
                ? localStorage.getItem(key) !== 'false'
                : localStorage.getItem(key) === 'true';
            localStorage.setItem(key, !current);
            updateSettingsToggles();
        }

        function updateSettingsToggles() {
            const settings = ['sound', 'vibration', 'confirm'];
            settings.forEach(setting => {
                const enabled = localStorage.getItem(`eventTools_${setting}`) !== 'false';
                const toggle = document.getElementById(`${setting}Toggle`);
                if (toggle) toggle.classList.toggle('active', enabled);
            });
            
        }

        function getSettings() {
            return {
                sound: localStorage.getItem('eventTools_sound') !== 'false',
                vibration: localStorage.getItem('eventTools_vibration') !== 'false',
                confirm: localStorage.getItem('eventTools_confirm') !== 'false'
            };
        }

        function exportData() {
            const data = {
                teams: localStorage.getItem('eventToolsTeams'),
                scoring: localStorage.getItem('eventToolsScoring'),
                // schedule removed
                notes: localStorage.getItem('eventToolsNotes'),
                settings: {
                    accent: localStorage.getItem('eventToolsAccent'),
                    fontSize: localStorage.getItem('eventToolsFontSize'),
                    theme: localStorage.getItem('eventToolsTheme'),
                    sound: localStorage.getItem('eventTools_sound'),
                    vibration: localStorage.getItem('eventTools_vibration'),
                    confirm: localStorage.getItem('eventTools_confirm')
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `event-tools-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importInput').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.teams) localStorage.setItem('eventToolsTeams', data.teams);
                    if (data.scoring) localStorage.setItem('eventToolsScoring', data.scoring);
                    // schedule removed
                    if (data.notes) localStorage.setItem('eventToolsNotes', data.notes);
                    if (data.settings) {
                        if (data.settings.accent) localStorage.setItem('eventToolsAccent', data.settings.accent);
                        if (data.settings.fontSize) localStorage.setItem('eventToolsFontSize', data.settings.fontSize);
                        if (data.settings.theme) localStorage.setItem('eventToolsTheme', data.settings.theme);
                        if (data.settings.sound) localStorage.setItem('eventTools_sound', data.settings.sound);
                        if (data.settings.vibration) localStorage.setItem('eventTools_vibration', data.settings.vibration);
                        if (data.settings.confirm) localStorage.setItem('eventTools_confirm', data.settings.confirm);
                    }
                    loadCustomization();
                    alert('Data imported successfully!');
                } catch (err) {
                    alert('Invalid backup file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Search
        const searchItems = [
            { name: 'Team Generator', type: 'tool', action: () => window.location.href = 'teamgen.html' },
            { name: 'Scoring', type: 'tool', action: () => window.location.href = 'scoring.html' },
            { name: 'Timer', type: 'tool', action: () => window.location.href = 'timer.html' },
            // schedule removed
            { name: 'Random Picker', type: 'tool', action: () => window.location.href = 'picker.html' },
            { name: 'Notes', type: 'tool', action: () => window.location.href = 'notes.html' },
            { name: 'Controller', type: 'tool', action: () => window.location.href = 'controller.html' },
            { name: 'Display', type: 'tool', action: () => window.open('display.html', '_blank') },
            { name: 'New Event', type: 'action', action: () => { closeSearch(); showNewEventModal(); } },
            { name: 'Customize', type: 'action', action: () => { closeSearch(); showCustomizeModal(); } },
            { name: 'Attention', type: 'action', action: () => { closeSearch(); playAttention(); } },
            { name: 'Experimental Features', type: 'feature', action: () => { toggleSetting('experimental'); filterSearch(); }, isToggle: true, getState: () => localStorage.getItem('eventTools_experimental') === 'true' },
            { name: 'Sound Effects', type: 'feature', action: () => { toggleSetting('sound'); filterSearch(); }, isToggle: true, getState: () => localStorage.getItem('eventTools_sound') !== 'false' },
            { name: 'Vibration', type: 'feature', action: () => { toggleSetting('vibration'); filterSearch(); }, isToggle: true, getState: () => localStorage.getItem('eventTools_vibration') !== 'false' },
            { name: 'Confirm before clearing', type: 'feature', action: () => { toggleSetting('confirm'); filterSearch(); }, isToggle: true, getState: () => localStorage.getItem('eventTools_confirm') !== 'false' },
            { name: 'Dark Theme', type: 'feature', action: () => { setTheme('dark'); filterSearch(); } },
            { name: 'Light Theme', type: 'feature', action: () => { setTheme('light'); filterSearch(); } },
        ];

        function showSearch() {
            document.getElementById('searchModal').style.display = 'flex';
            const input = document.getElementById('searchInput');
            input.value = '';
            input.focus();
            filterSearch();
        }

        function closeSearch() {
            document.getElementById('searchModal').style.display = 'none';
        }

        document.getElementById('searchModal').addEventListener('click', (e) => {
            if (e.target.id === 'searchModal') closeSearch();
        });

        function filterSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const results = document.getElementById('searchResults');

            if (!query) {
                results.innerHTML = '<div class="text-muted text-center" style="padding: 1rem;">Start typing to search...</div>';
                return;
            }

            const experimentalEnabled = localStorage.getItem('eventTools_experimental') === 'true';
            const filtered = searchItems.filter(item => {
                if (item.requiresExperimental && !experimentalEnabled) return false;
                return item.name.toLowerCase().includes(query);
            });
            results.innerHTML = filtered.map((item, i) => {
                const typeLabel = item.type === 'tool' ? 'Tool' : item.type === 'experimental' ? 'Experimental' : item.type === 'feature' ? 'Feature' : 'Action';
                const toggleState = item.isToggle ? `<span class="search-toggle ${item.getState() ? 'on' : ''}">${item.getState() ? 'ON' : 'OFF'}</span>` : '';
                return `<div class="search-item" onclick="searchItems[${searchItems.indexOf(item)}].action()">
                    <div>
                        <div class="search-item-name">${item.name}</div>
                        <div class="search-item-type">${typeLabel}</div>
                    </div>
                    ${toggleState}
                </div>`;
            }).join('');

            if (filtered.length === 0) {
                results.innerHTML = '<div class="text-muted text-center" style="padding: 1rem;">No results</div>';
            }
        }

        // Onboarding
        let onboardStep = 0;
        const ONBOARD_TOTAL_STEPS = 3;

        function startOnboarding() {
            onboardStep = 0;
            document.getElementById('onboardPeople').value = '';
            showOnboardStep(0);
            document.getElementById('onboarding').style.display = 'flex';
            updateCustomizeSelection();
        }

        function skipOnboarding() {
            localStorage.setItem('eventTools_onboarded', 'true');
            document.getElementById('onboarding').style.display = 'none';
        }

        function showOnboardStep(step) {
            onboardStep = step;
            document.querySelectorAll('.onboard-step').forEach(el => {
                el.style.display = el.dataset.step == step ? 'block' : 'none';
            });
            document.querySelectorAll('.onboard-dot').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.step) <= step);
            });

            const backBtn = document.getElementById('onboardBack');
            const nextBtn = document.getElementById('onboardNext');
            backBtn.style.display = step > 0 ? 'inline-block' : 'none';

            if (step === 0) {
                nextBtn.textContent = 'Get Started';
            } else if (step === ONBOARD_TOTAL_STEPS - 1) {
                nextBtn.textContent = 'Finish';
            } else {
                nextBtn.textContent = 'Next';
            }

            if (step === 2) updateCustomizeSelection();
        }

        function onboardNext() {
            if (onboardStep === 1) saveOnboardPeople();

            if (onboardStep >= ONBOARD_TOTAL_STEPS - 1) {
                finishOnboarding();
            } else {
                showOnboardStep(onboardStep + 1);
            }
        }

        function onboardPrev() {
            if (onboardStep > 0) showOnboardStep(onboardStep - 1);
        }

        function saveOnboardPeople() {
            const input = document.getElementById('onboardPeople').value;
            const names = input.split('\n').map(n => n.trim()).filter(n => n);
            if (names.length > 0) {
                localStorage.setItem('eventToolsParticipants', JSON.stringify(names));
                const teamSize = Math.ceil(names.length / 4);
                const shuffled = [...names].sort(() => Math.random() - 0.5);
                const teams = [];
                for (let i = 0; i < shuffled.length; i += teamSize) {
                    teams.push({
                        name: `Team ${teams.length + 1}`,
                        members: shuffled.slice(i, i + teamSize)
                    });
                }
                localStorage.setItem('eventToolsTeams', JSON.stringify(teams));
            }
        }

        // schedule onboarding removed

        function finishOnboarding() {
            localStorage.setItem('eventTools_onboarded', 'true');
            document.getElementById('onboarding').style.display = 'none';
        }

        // Auto-show on first visit
        if (!localStorage.getItem('eventTools_onboarded')) {
            startOnboarding();
        }

        function playAttention() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, i * 400);
            }
            
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }
    </script>
</body>
</html>